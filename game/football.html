<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Super Football Game ⚽</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  * { box-sizing: border-box; }
  body, html {
    margin: 0; padding: 0;
    height: 100%;
    background: linear-gradient(180deg, #0a3d0a 0%, #1a7d1a 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    user-select: none;
  }
  #container {
    position: relative;
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
  }
  canvas {
    display: block;
    background: #144214;
    border-radius: 12px;
    box-shadow: 0 0 24px rgba(0,0,0,0.8);
    max-width: 600px;
    max-height: 90vh;
    width: 100%;
    height: auto;
  }
  #info {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: #f0f0f0;
    font-weight: 700;
    font-size: 20px;
    padding: 10px 20px;
    border-radius: 30px;
    text-shadow: 0 0 6px #000;
    z-index: 10;
    pointer-events: none;
    min-width: 280px;
    text-align: center;
  }
  #answerDisplay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: clamp(28px, 8vw, 60px);
    font-weight: 900;
    color: #00ff88;
    text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88;
    display: none;
    z-index: 15;
  }
  @media (max-width: 400px) {
    #info { font-size: 16px; min-width: 200px; padding: 8px 16px; }
  }
</style>
</head>
<body>
<div id="container">
  <canvas id="footballCanvas"></canvas>
  <div id="info">Loading question...</div>
  <div id="answerDisplay"></div>
</div>

<script>
(async () => {
  // ---------------- FIREBASE SETUP ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyAPrVzvydC3GuoMe_ztdOi0CBhvg-Cckxw",
    authDomain: "crobot-tech.firebaseapp.com",
    projectId: "crobot-tech",
    storageBucket: "crobot-tech.appspot.com",
    messagingSenderId: "913013774056",
    appId: "1:913013774056:web:b00707f1d9c5f357389b5d",
    measurementId: "G-CVWVFJ9JHX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------------- LOAD QUESTION ----------------
  let currentQuestion = "Loading...";
  let correctAnswer = "";
  let wrongAnswer = "";
  let correctGoal = Math.random() < 0.5 ? 'top' : 'bottom';

  async function loadRandomQuestion() {
    try {
      const snapshot = await db.collection("levels").doc("medium").collection("medium").get();
      if (!snapshot.empty) {
        const docs = snapshot.docs;
        const randomDoc = docs[Math.floor(Math.random() * docs.length)];
        const data = randomDoc.data();
        currentQuestion = data.Question || "No question";
        correctAnswer = data["Correct Answer"] || "Correct";
        wrongAnswer = data["Wrong Answer"] || "Wrong";
        info.textContent = "Swipe to kick the ball!";
      } else {
        currentQuestion = "⚠️ No questions found!";
        correctAnswer = "A";
        wrongAnswer = "B";
      }
    } catch (err) {
      console.error("Error loading question:", err);
      currentQuestion = "⚠️ Error loading question!";
    }
  }

  // ---------------- CANVAS SETUP ----------------
  const canvas = document.getElementById('footballCanvas');
  const ctx = canvas.getContext('2d');
  const info = document.getElementById('info');
  const answerDisplay = document.getElementById('answerDisplay');

  function resizeCanvas() {
    const w = Math.min(window.innerWidth, 600);
    const h = Math.min(window.innerHeight * 0.9, 700);
    canvas.width = w;
    canvas.height = h;
  }
  resizeCanvas();
  window.addEventListener('resize', () => { resizeCanvas(); resetBall(); });

  let W = canvas.width, H = canvas.height;
  const goalWidthRatio = 0.4;
  const goalHeight = 50;
  const friction = 0.97;

  let ball = { x: W / 2, y: H / 2, r: 18, vx: 0, vy: 0, moving: false };

  // ---------------- GOAL KEEPERS (visual only) ----------------
  const keeperImg = new Image();
  keeperImg.src = "bheem.png"; // decorative only

  const keeper = {
    top: { x: 0, y: goalHeight + 5, width: 60, height: 90, dir: 1, speed: 1.8, offset: 0 },
    bottom: { x: 0, y: 0, width: 60, height: 90, dir: 1, speed: 1.8, offset: 0 }
  };

  function updateKeepersPosition() {
    const goalWidth = W * goalWidthRatio;
    keeper.top.y = goalHeight + 5;
    keeper.top.x = W / 2 - goalWidth / 2 + 20;
    keeper.bottom.y = H - goalHeight - keeper.bottom.height - 5;
    keeper.bottom.x = W / 2 - goalWidth / 2 + 20;
  }

  function animateKeepers() {
    const goalWidth = W * goalWidthRatio;
    for (const key of ['top', 'bottom']) {
      const k = keeper[key];
      k.offset += k.dir * k.speed;
      if (k.offset > goalWidth - k.width - 40) k.dir = -1;
      else if (k.offset < 0) k.dir = 1;
      k.x = W / 2 - goalWidth / 2 + 20 + k.offset;

      if (keeperImg.complete && keeperImg.naturalWidth > 0) {
        ctx.drawImage(keeperImg, k.x, k.y, k.width, k.height);
      }
    }
  }

  // ---------------- DRAW FIELD ----------------
  function drawField() {
    const goalWidth = W * goalWidthRatio;
    ctx.fillStyle = '#144214';
    ctx.fillRect(0, 0, W, H);

    ctx.strokeStyle = '#ffffffbb';
    ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(W / 2, 0); ctx.lineTo(W / 2, H); ctx.stroke();

    ctx.beginPath(); ctx.arc(W / 2, H / 2, 60, 0, Math.PI * 2); ctx.stroke();

    ctx.fillStyle = '#ffffffcc';
    ctx.fillRect(W / 2 - goalWidth / 2, 0, goalWidth, goalHeight);
    ctx.fillRect(W / 2 - goalWidth / 2, H - goalHeight, goalWidth, goalHeight);

    ctx.strokeStyle = '#f2e394';
    ctx.lineWidth = 3;
    ctx.strokeRect(W / 2 - goalWidth / 2, 0, goalWidth, goalHeight);
    ctx.strokeRect(W / 2 - goalWidth / 2, H - goalHeight, goalWidth, goalHeight);

    const topLabel = (correctGoal === 'top') ? correctAnswer : wrongAnswer;
    const bottomLabel = (correctGoal === 'bottom') ? correctAnswer : wrongAnswer;

    ctx.save();
    ctx.fillStyle = '#111';
    ctx.font = 'bold 16px Segoe UI';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(topLabel, W / 2, goalHeight / 2);
    ctx.fillText(bottomLabel, W / 2, H - goalHeight / 2);
    ctx.restore();
  }

  // ---------------- DRAW BALL ----------------
  function drawBall() {
    ctx.save();
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.strokeStyle = '#222';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `bold ${Math.min(13, W * 0.035)}px Segoe UI`;
    // 🔥 Glowing red question text
ctx.shadowColor = '#ff2222';
ctx.shadowBlur = 20;
ctx.fillStyle = '#ff3333';
ctx.strokeStyle = '#000';
ctx.lineWidth = 3;
ctx.font = `bold ${Math.min(13, W * 0.035)}px Segoe UI`;
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.strokeText(currentQuestion, ball.x, ball.y);
ctx.fillText(currentQuestion, ball.x, ball.y);
ctx.shadowBlur = 0; // reset shadow after drawing

    ctx.restore();
  }

  // ---------------- MOVE BALL ----------------
  function moveBall() {
    if (!ball.moving) return;
    ball.x += ball.vx; ball.y += ball.vy;
    ball.vx *= friction; ball.vy *= friction;
    if (Math.abs(ball.vx) < 0.15 && Math.abs(ball.vy) < 0.15) ball.moving = false;

    const goalWidth = W * goalWidthRatio;
    if (ball.x - ball.r < 0) { ball.x = ball.r; ball.vx *= -0.7; }
    if (ball.x + ball.r > W) { ball.x = W - ball.r; ball.vx *= -0.7; }

    if (ball.y - ball.r < 0 && !(ball.x > W/2 - goalWidth/2 && ball.x < W/2 + goalWidth/2)) {
      ball.y = ball.r; ball.vy *= -0.7;
    }
    if (ball.y + ball.r > H && !(ball.x > W/2 - goalWidth/2 && ball.x < W/2 + goalWidth/2)) {
      ball.y = H - ball.r; ball.vy *= -0.7;
    }
  }

  // ---------------- CHECK GOAL ----------------
  function checkGoal() {
    const goalWidth = W * goalWidthRatio;
    // Top goal
    if (ball.y - ball.r < goalHeight && ball.x > W/2 - goalWidth/2 && ball.x < W/2 + goalWidth/2) {
      if (correctGoal === 'top') handleCorrectGoal();
      else handleWrongGoal();
    }
    // Bottom goal
    if (ball.y + ball.r > H - goalHeight && ball.x > W/2 - goalWidth/2 && ball.x < W/2 + goalWidth/2) {
      if (correctGoal === 'bottom') handleCorrectGoal();
      else handleWrongGoal();
    }
  }

  function handleCorrectGoal() {
    displayMessage("✅ Correct!", "lime");
    showAnswer(correctAnswer);
    speakText(correctAnswer);
    setTimeout(() => window.location.href = "bike.html", 3000);
  }

  function handleWrongGoal() {
    displayMessage("❌ Wrong!", "red");
    setTimeout(() => window.location.reload(), 1500);
  }

  function displayMessage(text, color = "#fff") {
    info.textContent = text;
    info.style.color = color;
  }

  function showAnswer(answer) {
    answerDisplay.textContent = answer;
    answerDisplay.style.display = 'block';
  }

  function speakText(text) {
    if ('speechSynthesis' in window) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ta-IN'; // Tamil accent if applicable
      utter.rate = 1;
      utter.pitch = 1;
      window.speechSynthesis.speak(utter);
    }
  }

  function resetBall() {
    W = canvas.width; H = canvas.height;
    ball.x = W / 2; ball.y = H / 2; ball.vx = 0; ball.vy = 0; ball.moving = false;
    updateKeepersPosition();
    correctGoal = Math.random() < 0.5 ? 'top' : 'bottom';
  }

  // ---------------- SWIPE CONTROL ----------------
  let swipeStart = null, lastTouch = null;
  function handleSwipeStart(x, y) { swipeStart = { x, y }; lastTouch = Date.now(); }
  function handleSwipeEnd(x, y) {
    if (!swipeStart || ball.moving) return;
    const dx = x - swipeStart.x;
    const dy = y - swipeStart.y;
    if (Date.now() - lastTouch < 800) {
      ball.vx = Math.max(Math.min(dx / 12, 20), -20);
      ball.vy = Math.max(Math.min(dy / 12, 20), -20);
      ball.moving = true;
    }
    swipeStart = null;
  }

  canvas.addEventListener('mousedown', e => handleSwipeStart(e.offsetX, e.offsetY));
  canvas.addEventListener('mouseup', e => handleSwipeEnd(e.offsetX, e.offsetY));
  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    handleSwipeStart(t.clientX - rect.left, t.clientY - rect.top);
  }, { passive: false });
  canvas.addEventListener('touchend', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const t = e.changedTouches[0];
    handleSwipeEnd(t.clientX - rect.left, t.clientY - rect.top);
  }, { passive: false });

  // ---------------- MAIN LOOP ----------------
  function gameLoop() {
    ctx.clearRect(0, 0, W, H);
    drawField();
    animateKeepers();
    drawBall();
    moveBall();
    checkGoal();
    requestAnimationFrame(gameLoop);
  }

  await loadRandomQuestion();
  updateKeepersPosition();
  gameLoop();
})();
</script>
</body>
</html>
