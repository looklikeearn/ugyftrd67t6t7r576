<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Movie</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(45deg, #36d1dc, #5b86e5);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background-color: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      width: 400px;
      text-align: center;
    }

    h2 {
      margin-bottom: 20px;
      color: #333;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 16px;
      background-color: #f9f9f9;
      transition: 0.3s;
    }

    input[type="file"]:hover, select:hover, textarea:hover {
      background-color: #e1e1e1;
    }

    button {
      width: 100%;
      padding: 14px;
      background-color: #5b86e5;
      color: white;
      border: none;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #36d1dc;
    }

    .error-message, .success-message {
      margin-top: 10px;
      font-size: 14px;
    }

    .error-message {
      color: red;
    }

    .success-message {
      color: green;
    }

    .progress-bar-container {
      width: 100%;
      height: 20px;
      background-color: #e1e1e1;
      border-radius: 10px;
      margin: 10px 0;
      display: none; /* Hidden by default */
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #5b86e5;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Upload Movie</h2>

    <form id="uploadForm">
      <input type="text" id="title" placeholder="Enter Movie Title" required><br>
      <textarea id="description" placeholder="Enter Description" rows="4" required></textarea><br>
      
      <input type="text" id="tags" placeholder="Enter Tags (comma separated)" required><br>

      <select id="category" required>
        <option value="" disabled selected>Select Category</option>
        <option value="movie">Movie</option>
        <option value="series">Series</option>
        <option value="episode">Episode</option>
        <option value="comedy">Comedy</option>
        <option value="drama">Drama</option>
        <option value="action">Action</option>
        <option value="adventure">Adventure</option>
        <option value="horror">Horror</option>
        <option value="sci-fi">Sci-Fi</option>
        <option value="romance">Romance</option>
        <option value="fantasy">Fantasy</option>
        <option value="thriller">Thriller</option>
        <option value="mystery">Mystery</option>
        <option value="documentary">Documentary</option>
        <option value="animation">Animation</option>
        <option value="biography">Biography</option>
        <option value="crime">Crime</option>
        <option value="family">Family</option>
        <option value="music">Music</option>
        <option value="history">History</option>
        <option value="war">War</option>
        <option value="western">Western</option>
        <option value="reality">Reality</option>
        <option value="talk-show">Talk Show</option>
        <option value="sport">Sport</option>
        <option value="musical">Musical</option>
        <option value="superhero">Superhero</option>
      </select><br>

      <select id="age-restriction" required>
        <option value="" disabled selected>Select Age Restriction</option>
        <option value="G">G - General Audiences (All Ages)</option>
        <option value="PG">PG - Parental Guidance (Ages 5 and Up)</option>
        <option value="PG-13">PG-13 - Parents Strongly Cautioned (Ages 13 and Up)</option>
        <option value="R">R - Restricted (Ages 17 and Up)</option>
        <option value="NC-17">NC-17 - No One 17 and Under Admitted (Ages 18 and Up)</option>
        <option value="18+">18+ - Adults Only (Ages 18 and Up)</option>
      </select><br>
      
      <input type="file" id="video-file" accept="video/*"><br>
      <input type="file" id="thumbnail" accept="image/*" required><br>
      <input type="file" id="promo-video" accept="video/*"><br>

      <button type="submit">Upload Movie</button>
    </form>

    <div class="error-message" id="error-message"></div>
    <div class="success-message" id="success-message"></div>

    <!-- Progress Bar -->
    <div class="progress-bar-container" id="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDebZ98GjmX8gxYC4jI_gmiChm7TzFqsMg",
      authDomain: "test-d6f13.firebaseapp.com",
      projectId: "test-d6f13",
      storageBucket: "test-d6f13.appspot.com",
      messagingSenderId: "1043978393185",
      appId: "1:1043978393185:web:a40e50c013d7869b8cfc20",
      measurementId: "G-VLTFR2GXGS"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const firestore = getFirestore(app);

    const uploadForm = document.getElementById("uploadForm");
    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById("success-message");
    const progressBarContainer = document.getElementById("progress-bar-container");
    const progressBar = document.getElementById("progress-bar");

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMessage.textContent = "";
      successMessage.textContent = "";
      progressBarContainer.style.display = "block";  // Show progress bar

      const title = document.getElementById("title").value;
      const description = document.getElementById("description").value;
      const tags = document.getElementById("tags").value;
      const category = document.getElementById("category").value;
      const ageRestriction = document.getElementById("age-restriction").value;

      const videoFile = document.getElementById("video-file").files[0];
      const thumbnailFile = document.getElementById("thumbnail").files[0];
      const promoVideoFile = document.getElementById("promo-video").files[0];

      if (category === "series" && videoFile) {
        errorMessage.textContent = "Series cannot have video files. Please upload a video for movies or episodes.";
        return;
      }

      if (!thumbnailFile) {
        errorMessage.textContent = "Thumbnail is required.";
        return;
      }

      try {
        // Upload thumbnail file to Firebase Storage
        const thumbnailRef = ref(storage, `thumbnails/${title}.jpg`);
        const uploadThumbnailTask = uploadBytesResumable(thumbnailRef, thumbnailFile);

        // Track upload progress for thumbnail
        uploadThumbnailTask.on("state_changed", (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = progress + "%";
        });

        await uploadThumbnailTask;
        const thumbnailURL = await getDownloadURL(thumbnailRef);

        let videoURL = null;
        if (category !== "series" && videoFile) {
          // Upload video file if it's not a series
          const videoRef = ref(storage, `videos/${title}.mp4`);
          const uploadVideoTask = uploadBytesResumable(videoRef, videoFile);

          // Track upload progress for video
          uploadVideoTask.on("state_changed", (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.style.width = progress + "%";
          });

          await uploadVideoTask;
          videoURL = await getDownloadURL(videoRef);
        }

        let promoVideoURL = null;
        if (promoVideoFile) {
          // Upload promo video file if provided
          const promoRef = ref(storage, `promos/${title}_promo.mp4`);
          const uploadPromoTask = uploadBytesResumable(promoRef, promoVideoFile);

          // Track upload progress for promo video
          uploadPromoTask.on("state_changed", (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.style.width = progress + "%";
          });

          await uploadPromoTask;
          promoVideoURL = await getDownloadURL(promoRef);
        }

        // Save movie metadata to Firestore
        const movieData = {
          title,
          description,
          tags: tags.split(",").map(tag => tag.trim()),
          category,
          ageRestriction,
          videoURL,
          thumbnailURL,
          promoVideoURL: promoVideoURL || null,
          timestamp: new Date(),
        };

        await setDoc(doc(firestore, "movies", title), movieData);

        successMessage.textContent = "Movie uploaded successfully!";
        uploadForm.reset();
        progressBarContainer.style.display = "none";  // Hide progress bar
      } catch (error) {
        console.error("Error uploading movie:", error);
        errorMessage.textContent = "An error occurred while uploading. Please try again.";
      }
    });
  </script>
</body>
</html>
