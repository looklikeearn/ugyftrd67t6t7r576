<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Car Game</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  width: 100%;
  height: 100%;
  background: linear-gradient(180deg, #1e1e1e 0%, #000 100%);
  font-family: 'Arial', sans-serif;
}
canvas {
  display: block;
  margin: 0 auto;
  background: #2d2d2d;
}
.info {
  position: absolute;
  width: 100%;
  top: 5%;
  color: rgb(255, 231, 13);
  font-size: min(28px, 6vw);
  text-align: center;
  z-index: 10;
  text-shadow: 0 0 10px rgba(0,0,0,0.7);
}
button {
  padding: 14px 24px;
  font-size: min(20px, 4vw);
  border: none;
  border-radius: 12px;
  background: linear-gradient(145deg, #ffcc00, #ff9900);
  color: #000;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(255, 255, 0, 0.3);
  transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
  position: absolute;
}
button:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 15px rgba(255, 255, 0, 0.5);
}
button.wrong {
  background: linear-gradient(145deg, #ff4d4d, #ff0000);
  color: #fff;
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div class="info" id="info">üèéÔ∏è </div>
<button id="btn1">Answer 1</button>
<button id="btn2">Answer 2</button>

<script>
// ---------------- Firebase Setup ----------------
// ---------------- Firebase Setup ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAPrVzvydC3GuoMe_ztdOi0CBhvg-Cckxw",
  authDomain: "crobot-tech.firebaseapp.com",
  projectId: "crobot-tech",
  storageBucket: "crobot-tech.firebasestorage.app",
  messagingSenderId: "913013774056",
  appId: "1:913013774056:web:b00707f1d9c5f357389b5d",
  measurementId: "G-CVWVFJ9JHX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------- Canvas Setup ----------------
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const info = document.getElementById('info');
const btn1 = document.getElementById('btn1');
const btn2 = document.getElementById('btn2');

let W, H;
function resizeCanvas() {
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ---------------- Game Objects ----------------
const road = { x: 0, y: 0, width: W, height: H, color: '#444' };
const laneCount = 2;
const laneWidth = road.width / laneCount;

const car = {
  w: W * 0.35,   // increased from 0.25 ‚Üí 0.35
  h: W * 0.35,   // increased from 0.25 ‚Üí 0.35
  x: W / 2 - (W * 0.175),
  y: H - W * 0.35 - 20,
  moving: false,
  target: null
};

let finishLines = [];
let glowPhase = 0;
let gameOver = false;
let showAnswer = null;
let currentQuestion = "", correctAnswer = "", wrongAnswer = "";

// ---------------- Load Question ----------------
async function loadRandomQuestion() {
  try {
    const snapshot = await db.collection("levels").doc("medium").collection("medium").get();
    if (!snapshot.empty) {
      const docs = snapshot.docs;
      const randomDoc = docs[Math.floor(Math.random() * docs.length)];
      const data = randomDoc.data();
      currentQuestion = data.Question || "‡Æµ‡Æø‡Æ≥‡Øà‡ÆØ‡Ææ‡Æü‡Øç‡Æü‡ØÅ ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ!";
      correctAnswer = data["Correct Answer"] || "Correct";
      wrongAnswer = data["Wrong Answer"] || "Wrong";
      updateFinishLines();
    }
  } catch (err) {
    console.error("Error loading question:", err);
    currentQuestion = "‚ö†Ô∏è ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø ‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà!";
  }
}

// ---------------- Finish Lines ----------------
function updateFinishLines() {
  // keep buttons at top
  const btnTop = 50; // fixed top for buttons
  finishLines = [
    { lane: 0, y: btnTop, w: laneWidth - 40, h: 60, answer: correctAnswer },
    { lane: 1, y: btnTop, w: laneWidth - 40, h: 60, answer: wrongAnswer }
  ];
  shuffle(finishLines);
  positionButtons();
  btn1.classList.remove("wrong");
  btn2.classList.remove("wrong");
  gameOver = false;
  showAnswer = null;
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// ---------------- Position Buttons ----------------
function positionButtons() {
  finishLines.forEach((f, index) => {
    const btn = index === 0 ? btn1 : btn2;
    btn.style.width = `${f.w}px`;
    btn.style.height = `${f.h}px`;
    btn.style.left = `${road.x + f.lane * laneWidth + 20}px`;
    btn.style.top = `${f.y}px`;
    btn.textContent = f.answer;
  });
}

// ---------------- Car Image ----------------
const carImg = new Image();
carImg.src = "car.png";

// ---------------- Draw ----------------
function drawRoad() {
  ctx.fillStyle = road.color;
  ctx.fillRect(road.x, road.y, road.width, road.height);
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 4;
  ctx.setLineDash([30, 30]);
  const midX = road.x + laneWidth;
  ctx.beginPath();
  ctx.moveTo(midX, 0);
  ctx.lineTo(midX, H);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawFinishLines() {
  glowPhase += 0.05;
  const glowIntensity = Math.sin(glowPhase) * 0.5 + 0.5;
  finishLines.forEach(f => {
    const fx = road.x + f.lane * laneWidth + 20;
    ctx.shadowBlur = 20 * glowIntensity;
    ctx.shadowColor = `rgba(255,255,100,${0.3 + glowIntensity * 0.4})`;
    ctx.fillStyle = '#ffd700';
    ctx.fillRect(fx, f.y, f.w, f.h);
    ctx.shadowBlur = 0;
  });
}

function drawCar() {
  if (carImg.complete) ctx.drawImage(carImg, car.x, car.y, car.w, car.h);
}

function drawQuestionNearCar() {
  ctx.save();
  ctx.shadowColor = 'rgba(255, 50, 50, 0.8)'; // üî• glow color
  ctx.shadowBlur = 15;
  ctx.fillStyle = 'rgb(255, 80, 80)'; // üü• text color
  ctx.font = `bold ${Math.min(32, W * 0.05)}px Arial`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'bottom';
  
  const x = car.x + car.w / 2;
  const y = car.y - 10;
  const text = currentQuestion;

  // Draw wrapped text with border and fill
  ctx.lineWidth = 4;
  ctx.strokeStyle = 'white'; // üü¶ border color
  wrapTextWithBorder(ctx, text, x, y, laneWidth - 20, 28);
  ctx.restore();
}


// helper to draw text with both stroke and fill
function wrapTextWithBorder(context, text, x, y, maxWidth, lineHeight) {
  const words = text.split(' ');
  let line = '';
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + ' ';
    const metrics = context.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      context.strokeText(line, x, y);
      context.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  context.strokeText(line, x, y);
  context.fillText(line, x, y);
}


function drawCenterAnswer() {
  if (!showAnswer) return;
  ctx.fillStyle = '#00ff00';
  ctx.shadowBlur = 25;
  ctx.shadowColor = '#00ff00';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  let fontSize = Math.min(96, W * 0.15);
  ctx.font = `${fontSize}px Arial Black`;

  const textWidth = ctx.measureText(showAnswer).width;
  if (textWidth > W * 0.9) {
    fontSize *= (W * 0.9 / textWidth);
    ctx.font = `${fontSize}px Arial Black`;
  }

  ctx.fillText(showAnswer.toUpperCase(), W / 2, H / 2);
  ctx.shadowBlur = 0;
}

function wrapText(context, text, x, y, maxWidth, lineHeight) {
  const words = text.split(' ');
  let line = '';
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + ' ';
    const metrics = context.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      context.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  context.fillText(line, x, y);
}

// ---------------- Game Logic ----------------
function handleAnswerClick(index) {
  if (car.moving || gameOver) return;
  car.target = finishLines[index];
  car.moving = true;
  info.textContent = "üèéÔ∏è";
  if (finishLines[index].answer !== correctAnswer) {
    if (index === 0) btn1.classList.add("wrong");
    else btn2.classList.add("wrong");
  }
}

function moveCar() {
  if (!car.target) return;
  const targetX = road.x + car.target.lane * laneWidth + laneWidth / 2 - car.w / 2;
  const targetY = car.target.y + car.target.h + 20;
  car.x += (targetX - car.x) * 0.1;
  car.y += (targetY - car.y) * 0.05;

  if (Math.abs(car.y - targetY) < 3) decideResult(car.target.answer);
}

function decideResult(answer) {
  gameOver = true;
  car.moving = false;
  if (answer === correctAnswer) {
    showAnswer = answer;
    info.textContent = `‚úÖ ${answer} ‚úÖ`;
    speakAnswer(answer);
    setTimeout(() => window.location.href = "football.html", 2500);
  } else {
    info.textContent = "‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå";
    setTimeout(() => {
      resetCar();
      loadRandomQuestion();
    }, 2000);
  }
}

function resetCar() {
  car.x = W / 2 - (W * 0.125);
  car.y = H - W * 0.25 - 20;
  car.moving = false;
  car.target = null;
  gameOver = false;
  showAnswer = null;
  btn1.classList.remove("wrong");
  btn2.classList.remove("wrong");
  positionButtons();
}

function speakAnswer(text) {
  if (!window.speechSynthesis) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'en-US';
  utter.pitch = 1.2;
  utter.rate = 0.9;
  window.speechSynthesis.speak(utter);
}

// ---------------- Game Loop ----------------
function gameLoop() {
  ctx.clearRect(0, 0, W, H);
  drawRoad();
  drawFinishLines();
  drawCar();
  drawQuestionNearCar();
  drawCenterAnswer();
  if (car.moving) moveCar();
  requestAnimationFrame(gameLoop);
}

// ---------------- Start ----------------
btn1.addEventListener('click', () => handleAnswerClick(0));
btn2.addEventListener('click', () => handleAnswerClick(1));
loadRandomQuestion();
gameLoop();

</script>
</body>
</html>
