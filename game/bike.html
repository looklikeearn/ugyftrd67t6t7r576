<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Bike Challenge üèçÔ∏è</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at top, #3a0ca3, #000);
  font-family: 'Poppins', sans-serif;
}
canvas {
  display: block;
  margin: 0 auto;
  background: linear-gradient(180deg, #1e1e50, #0a002a);
}
.info {
  position: absolute;
  width: 100%;
  top: 5%;
  color: #39ff14;
  font-size: min(28px, 6vw);
  text-align: center;
  z-index: 10;
  text-shadow: 0 0 20px rgba(0,255,100,0.8);
}
button {
  padding: 14px 24px;
  font-size: min(20px, 4vw);
  border: none;
  border-radius: 20px;
  background: linear-gradient(145deg, #00e0ff, #0066ff);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 255, 255, 0.3);
  transition: transform 0.2s, box-shadow 0.2s;
  position: absolute;
}
button:hover {
  transform: scale(1.08);
  box-shadow: 0 6px 15px rgba(0, 255, 255, 0.6);
}
button.wrong {
  background: linear-gradient(145deg, #ff4d4d, #ff0000);
  color: #fff;
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div class="info" id="info">üèçÔ∏è</div>
<button id="btn1">Answer 1</button>
<button id="btn2">Answer 2</button>

<script>
// ---------------- Firebase Setup ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAPrVzvydC3GuoMe_ztdOi0CBhvg-Cckxw",
  authDomain: "crobot-tech.firebaseapp.com",
  projectId: "crobot-tech",
  storageBucket: "crobot-tech.firebasestorage.app",
  messagingSenderId: "913013774056",
  appId: "1:913013774056:web:b00707f1d9c5f357389b5d",
  measurementId: "G-CVWVFJ9JHX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------- Canvas Setup ----------------
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const info = document.getElementById('info');
const btn1 = document.getElementById('btn1');
const btn2 = document.getElementById('btn2');

let W, H;
function resizeCanvas() {
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ---------------- Game Objects ----------------
const road = { x: 0, y: 0, width: W, height: H, color: '#1a1a50' };
const laneCount = 2;
const laneWidth = road.width / laneCount;

const bike = {
  w: W * 0.3,
  h: W * 0.3,
  x: W / 2 - (W * 0.15),
  y: H - W * 0.3 - 20,
  moving: false,
  target: null
};

let finishLines = [];
let glowPhase = 0;
let gameOver = false;
let showAnswer = null;
let currentQuestion = "", correctAnswer = "", wrongAnswer = "";

// ---------------- Load Question ----------------
async function loadRandomQuestion() {
  try {
    const snapshot = await db.collection("levels").doc("medium").collection("medium").get();
    if (!snapshot.empty) {
      const docs = snapshot.docs;
      const randomDoc = docs[Math.floor(Math.random() * docs.length)];
      const data = randomDoc.data();
      currentQuestion = data.Question || "üèÅ Get ready!";
      correctAnswer = data["Correct Answer"] || "Correct";
      wrongAnswer = data["Wrong Answer"] || "Wrong";
      updateFinishLines();
    }
  } catch (err) {
    console.error("Error loading question:", err);
    currentQuestion = "‚ö†Ô∏è Error loading question!";
  }
}

// ---------------- Finish Lines ----------------
function updateFinishLines() {
  const btnTop = 50;
  finishLines = [
    { lane: 0, y: btnTop, w: laneWidth - 40, h: 60, answer: correctAnswer },
    { lane: 1, y: btnTop, w: laneWidth - 40, h: 60, answer: wrongAnswer }
  ];
  shuffle(finishLines);
  positionButtons();
  btn1.classList.remove("wrong");
  btn2.classList.remove("wrong");
  gameOver = false;
  showAnswer = null;
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function positionButtons() {
  finishLines.forEach((f, index) => {
    const btn = index === 0 ? btn1 : btn2;
    btn.style.width = `${f.w}px`;
    btn.style.height = `${f.h}px`;
    btn.style.left = `${road.x + f.lane * laneWidth + 20}px`;
    btn.style.top = `${f.y}px`;
    btn.textContent = f.answer;
  });
}

// ---------------- Bike Image ----------------
const bikeImg = new Image();
bikeImg.src = "bike.png";

// ---------------- Draw ----------------
function drawRoad() {
  ctx.fillStyle = road.color;
  ctx.fillRect(road.x, road.y, road.width, road.height);
  ctx.strokeStyle = `rgba(0, 255, 255, 0.7)`;
  ctx.lineWidth = 6;
  ctx.setLineDash([25, 25]);
  const midX = road.x + laneWidth;
  ctx.beginPath();
  ctx.moveTo(midX, 0);
  ctx.lineTo(midX, H);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawFinishLines() {
  glowPhase += 0.05;
  const glowIntensity = Math.sin(glowPhase) * 0.5 + 0.5;
  finishLines.forEach(f => {
    const fx = road.x + f.lane * laneWidth + 20;
    ctx.shadowBlur = 25 * glowIntensity;
    ctx.shadowColor = `rgba(0,255,255,${0.4 + glowIntensity * 0.5})`;
    ctx.fillStyle = '#00ffff';
    ctx.fillRect(fx, f.y, f.w, f.h);
    ctx.shadowBlur = 0;
  });
}

function drawSpeedTrail() {
  if (bike.moving) {
    const trailGradient = ctx.createLinearGradient(bike.x, bike.y, bike.x, bike.y + 100);
    trailGradient.addColorStop(0, "rgba(0,255,255,0.3)");
    trailGradient.addColorStop(1, "rgba(0,255,255,0)");
    ctx.fillStyle = trailGradient;
    ctx.fillRect(bike.x + bike.w / 3, bike.y + bike.h / 1.2, bike.w / 3, 100);
  }
}

function drawBike() {
  if (bikeImg.complete) ctx.drawImage(bikeImg, bike.x, bike.y, bike.w, bike.h);
}

function drawQuestionNearBike() {
  ctx.save();
  ctx.shadowColor = 'rgba(255, 0, 0, 0.9)';
  ctx.shadowBlur = 18;
  ctx.fillStyle = 'rgb(255, 50, 50)';
  ctx.font = `bold ${Math.min(32, W * 0.05)}px Poppins`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'bottom';
  const x = bike.x + bike.w / 2;
  const y = bike.y - 10;
  ctx.lineWidth = 4;
  ctx.strokeStyle = 'black';
  wrapTextWithBorder(ctx, currentQuestion, x, y, laneWidth - 20, 28);
  ctx.restore();
}

function wrapTextWithBorder(context, text, x, y, maxWidth, lineHeight) {
  const words = text.split(' ');
  let line = '';
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + ' ';
    const metrics = context.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      context.strokeText(line, x, y);
      context.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
    } else line = testLine;
  }
  context.strokeText(line, x, y);
  context.fillText(line, x, y);
}

// ‚úÖ Center "Correct" Text ‚Äî Always fits inside screen
function drawCenterAnswer() {
  if (!showAnswer) return;
  ctx.save();
  ctx.fillStyle = '#39ff14';
  ctx.shadowBlur = 40;
  ctx.shadowColor = '#39ff14';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  let fontSize = Math.min(W * 0.12, H * 0.10, 80);
  ctx.font = `bold ${fontSize}px Poppins`;

  // If too wide, shrink until fits screen
  while (ctx.measureText(showAnswer.toUpperCase()).width > W * 0.9) {
    fontSize *= 0.9;
    ctx.font = `bold ${fontSize}px Poppins`;
  }

  // Multi-line wrapping for long answers
  const words = showAnswer.toUpperCase().split(" ");
  let lines = [];
  let currentLine = "";
  for (let w of words) {
    const test = currentLine + w + " ";
    if (ctx.measureText(test).width > W * 0.8) {
      lines.push(currentLine.trim());
      currentLine = w + " ";
    } else currentLine = test;
  }
  lines.push(currentLine.trim());

  const totalHeight = lines.length * (fontSize * 1.2);
  let startY = H / 2 - totalHeight / 2 + fontSize / 2;
  lines.forEach(line => {
    ctx.fillText(line, W / 2, startY);
    startY += fontSize * 1.2;
  });

  ctx.restore();
}

// ---------------- Game Logic ----------------
function handleAnswerClick(index) {
  if (bike.moving || gameOver) return;
  bike.target = finishLines[index];
  bike.moving = true;
  info.textContent = "üèçÔ∏è";
  if (finishLines[index].answer !== correctAnswer) {
    (index === 0 ? btn1 : btn2).classList.add("wrong");
  }
}

function moveBike() {
  if (!bike.target) return;
  const targetX = road.x + bike.target.lane * laneWidth + laneWidth / 2 - bike.w / 2;
  const targetY = bike.target.y + bike.target.h + 20;
  bike.x += (targetX - bike.x) * 0.1;
  bike.y += (targetY - bike.y) * 0.05;
  if (Math.abs(bike.y - targetY) < 3) decideResult(bike.target.answer);
}

function decideResult(answer) {
  gameOver = true;
  bike.moving = false;
  if (answer === correctAnswer) {
    showAnswer = answer;
    info.textContent = `üèÜ ${answer}! Great Ride! üèÜ`;
    speakAnswer(answer);
    setTimeout(() => window.location.href = "tv.html", 2500);
  } else {
    info.textContent = "üí• Wrong Turn!";
    setTimeout(() => {
      resetBike();
      loadRandomQuestion();
    }, 2000);
  }
}

function resetBike() {
  bike.x = W / 2 - (W * 0.15);
  bike.y = H - W * 0.3 - 20;
  bike.moving = false;
  bike.target = null;
  gameOver = false;
  showAnswer = null;
  btn1.classList.remove("wrong");
  btn2.classList.remove("wrong");
  positionButtons();
}

function speakAnswer(text) {
  if (!window.speechSynthesis) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'en-US';
  utter.pitch = 1.1;
  utter.rate = 1.0;
  window.speechSynthesis.speak(utter);
}

// ---------------- Game Loop ----------------
function gameLoop() {
  ctx.clearRect(0, 0, W, H);
  drawRoad();
  drawFinishLines();
  drawSpeedTrail();
  drawBike();
  drawQuestionNearBike();
  drawCenterAnswer();
  if (bike.moving) moveBike();
  requestAnimationFrame(gameLoop);
}

// ---------------- Start ----------------
btn1.addEventListener('click', () => handleAnswerClick(0));
btn2.addEventListener('click', () => handleAnswerClick(1));
loadRandomQuestion();
gameLoop();
</script>
</body>
</html>
