<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìä Full Expense Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">

  <header class="mb-6">
    <h1 class="text-3xl font-bold text-blue-700 mb-2">Full Expense Report</h1>
  </header>

  <div class="mb-4 flex flex-col md:flex-row md:items-center gap-4">
    <button id="downloadBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition">
      ‚¨áÔ∏è Download Excel file
    </button>

    <input
      type="text"
      id="searchInput"
      placeholder="üîç Search by description or date..."
      class="border border-gray-300 rounded-md px-4 py-2 w-full md:w-1/3"
    />

    <select id="sortSelect" class="border border-gray-300 rounded-md px-4 py-2 w-full md:w-1/4">
      <option value="date_desc">üìÖ Date (Newest)</option>
      <option value="date_asc">üìÖ Date (Oldest)</option>
      <option value="amount_desc">üí∞ Amount (High to Low)</option>
      <option value="amount_asc">üí∞ Amount (Low to High)</option>
    </select>
  </div>

  <div class="grid md:grid-cols-2 gap-6">
    <div class="bg-white p-4 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-3 text-blue-600">üìÖ Month-wise Totals</h2>
      <ul id="monthSummary" class="text-sm space-y-2 text-gray-800"></ul>
    </div>

    <div class="bg-white p-4 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-3 text-blue-600">üìÜ Year-wise Totals</h2>
      <ul id="yearSummary" class="text-sm space-y-2 text-gray-800"></ul>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-6">
    <h2 class="text-xl font-semibold mb-3 text-blue-600">üßæ All Expenses</h2>
    <ul id="fullList" class="text-sm space-y-3 max-h-[500px] overflow-y-auto text-gray-700"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAPrVzvydC3GuoMe_ztdOi0CBhvg-Cckxw",
      authDomain: "crobot-tech.firebaseapp.com",
      projectId: "crobot-tech",
      storageBucket: "crobot-tech.firebasestorage.app",
      messagingSenderId: "913013774056",
      appId: "1:913013774056:web:b00707f1d9c5f357389b5d",
      measurementId: "G-CVWVFJ9JHX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    if (localStorage.getItem('facultyLoggedIn') !== 'true') {
      alert("Please login first!");
      window.location.href = 'login.html';
    }

    const monthTotals = {};
    const yearTotals = {};
    const fullList = document.getElementById("fullList");
    const monthSummary = document.getElementById("monthSummary");
    const yearSummary = document.getElementById("yearSummary");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");

    let allExpenseData = [];

    function formatMonth(dateStr) {
      const [year, month] = dateStr.split("-");
      return `${year}-${month}`;
    }

    function renderExpenseList(data) {
      fullList.innerHTML = "";
      if (data.length === 0) {
        fullList.innerHTML = "<li class='text-gray-400'>No matching expenses found.</li>";
        return;
      }

      data.forEach(item => {
        const li = document.createElement("li");
        li.className = "border-b pb-2 border-gray-200";
        li.innerHTML = `
          <div class="flex justify-between">
            <span class="text-green-600 font-semibold">‚Çπ${item.amount.toFixed(2)}</span>
            <span class="text-gray-500 text-sm">${item.date}</span>
          </div>
          <div>${item.desc}</div>
          <div class="mt-2 flex justify-between">
            <button onclick="editExpense('${item.id}')" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 transition">‚úèÔ∏è Edit</button>
            <button onclick="deleteExpense('${item.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">‚ùå Delete</button>
          </div>
        `;
        fullList.appendChild(li);
      });
    }

    function renderSummaries() {
      const sortedMonths = Object.keys(monthTotals).sort().reverse();
      sortedMonths.forEach(month => {
        const li = document.createElement("li");
        li.textContent = `${month}: ‚Çπ${monthTotals[month].toFixed(2)}`;
        monthSummary.appendChild(li);
      });

      const sortedYears = Object.keys(yearTotals).sort().reverse();
      sortedYears.forEach(year => {
        const li = document.createElement("li");
        li.textContent = `${year}: ‚Çπ${yearTotals[year].toFixed(2)}`;
        yearSummary.appendChild(li);
      });
    }

    function applyFilters() {
      const query = searchInput.value.toLowerCase();
      const sortOption = sortSelect.value;

      let filtered = [...allExpenseData];

      if (query) {
        filtered = filtered.filter(item =>
          item.desc.toLowerCase().includes(query) ||
          item.date.toLowerCase().includes(query)
        );
      }

      switch (sortOption) {
        case "date_desc":
          filtered.sort((a, b) => b.date.localeCompare(a.date));
          break;
        case "date_asc":
          filtered.sort((a, b) => a.date.localeCompare(b.date));
          break;
        case "amount_desc":
          filtered.sort((a, b) => b.amount - a.amount);
          break;
        case "amount_asc":
          filtered.sort((a, b) => a.amount - b.amount);
          break;
      }

      renderExpenseList(filtered);
    }

    function loadAllExpenses() {
      db.collection("expends")
        .orderBy("timestamp", "desc")
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            fullList.innerHTML = "<li class='text-gray-400'>No expenses found.</li>";
            return;
          }

          allExpenseData = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            const amount = data.amount || 0;
            const desc = data.description || "(No description)";
            const date = data.date || "Unknown";
            const id = doc.id;

            allExpenseData.push({ amount, desc, date, id });

            const monthKey = formatMonth(date);
            const yearKey = date.split("-")[0];

            monthTotals[monthKey] = (monthTotals[monthKey] || 0) + amount;
            yearTotals[yearKey] = (yearTotals[yearKey] || 0) + amount;
          });

          renderSummaries();
          applyFilters();
        })
        .catch(err => {
          console.error("Error loading data:", err);
          fullList.innerHTML = `<li class="text-red-500">Error loading expenses.</li>`;
        });
    }

    function editExpense(id) {
      const expense = allExpenseData.find(exp => exp.id === id);
      const newAmount = prompt("Enter new amount:", expense.amount);
      const newDescription = prompt("Enter new description:", expense.desc);

      if (newAmount && newDescription) {
        db.collection("expends").doc(id).update({
          amount: parseFloat(newAmount),
          description: newDescription
        }).then(() => {
          alert("Expense updated!");
          window.location.reload();
        }).catch(error => {
          console.error("Error updating expense:", error);
          alert("Error updating expense.");
        });
      }
    }

    function deleteExpense(id) {
      if (confirm("Are you sure you want to delete this expense?")) {
        db.collection("expends").doc(id).delete()
          .then(() => {
            alert("Expense deleted!");
            window.location.reload();
          })
          .catch(error => {
            console.error("Error deleting expense:", error);
            alert("Error deleting expense.");
          });
      }
    }

    function downloadCSV() {
      if (allExpenseData.length === 0) {
        alert("No data to export!");
        return;
      }

      let csvContent = "data:text/csv;charset=utf-8,Date,Amount,Description\n";

      allExpenseData.forEach(item => {
        csvContent += `${item.date},${item.amount},"${item.desc.replace(/"/g, '""')}"\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `expends_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById("downloadBtn").addEventListener("click", downloadCSV);
    searchInput.addEventListener("input", applyFilters);
    sortSelect.addEventListener("change", applyFilters);

    loadAllExpenses();
  </script>
</body>
</html>
